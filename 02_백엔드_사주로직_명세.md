# 사주 로직 명세서 (saju_logic.py)

## 📌 개요

`SajuLogic` 클래스는 사주팔자 계산의 핵심 로직을 담당합니다. 총 705줄로 구성되며, 다음 기능을 제공합니다:

- 사주 원국 계산 (년/월/일/시주)
- 오행 분포 계산
- 십성(십신) 판정
- 대운 계산 (8주기, 80년)
- 근묘화실(생애주기) 분석
- 오늘의 운세

---

## 🔧 기본 데이터 구조

### 천간 (天干, Heavenly Stems)
```python
CHEONGAN = ['갑', '을', '병', '정', '무', '기', '경', '신', '임', '계']
# 인덱스:   0     1     2     3     4     5     6     7     8     9
```

### 지지 (地支, Earthly Branches)
```python
JIJI = ['자', '축', '인', '묘', '진', '사', '오', '미', '신', '유', '술', '해']
# 인덱스: 0     1     2     3     4     5     6     7     8     9    10    11
```

### 오행 매핑

**천간 오행 (STEM_OHAENG)**:
```python
['wood', 'wood', 'fire', 'fire', 'earth', 'earth', 'metal', 'metal', 'water', 'water']
# 갑을=목, 병정=화, 무기=토, 경신=금, 임계=수
```

**지지 오행 (BRANCH_OHAENG)**:
```python
['water', 'earth', 'wood', 'wood', 'earth', 'fire', 'fire', 'earth', 'metal', 'metal', 'earth', 'water']
# 자=수, 축=토, 인묘=목, 진=토, 사오=화, 미=토, 신유=금, 술=토, 해=수
```

---

## 🧮 핵심 알고리즘

### 1. 사주 원국 계산 `get_gan_zhi(year, month, day, hour, minute)`

#### 년주 (Year Pillar)
```python
# 입춘 기준 (2월 4일) 적용
is_before_lichun = (month < 2) or (month == 2 and day < 4)
calc_year = year - 1 if is_before_lichun else year

# 60갑자 순환 계산
year_idx = (calc_year - 4) % 60
year_stem_idx = year_idx % 10   # 천간 인덱스
year_branch_idx = year_idx % 12  # 지지 인덱스
```

#### 월주 (Month Pillar)
```python
# 년간에 따른 월간 시작점 (年上起月法)
month_start_stems = [2, 4, 6, 8, 0]  # 갑기=병, 을경=무, 병신=경, 정임=임, 무계=갑
start_stem = month_start_stems[year_stem_idx % 5]

# 절기 기준 간소화 (매월 5일 이전은 전월)
target_month = month
if day < 5:
    target_month = month - 1 if month > 1 else 12

month_branch_idx = target_month % 12
month_idx_from_feb = target_month - 2
if month_idx_from_feb < 0: month_idx_from_feb += 12
month_stem_idx = (start_stem + month_idx_from_feb) % 10
```

#### 일주 (Day Pillar)
```python
# 기준일: 2000년 1월 1일 = 무오(戊午) = 60갑자 54번째
ref_2000 = datetime(2000, 1, 1)
delta_days = (curr_date - ref_2000).days
day_cycle_idx = (54 + delta_days) % 60
day_stem_idx = day_cycle_idx % 10
day_branch_idx = day_cycle_idx % 12
```

#### 시주 (Hour Pillar)
```python
# 시지 계산 (2시간 단위, 자시=23:00~01:00)
hour_branch_idx = (hour + 1) // 2 % 12

# 일간에 따른 시간 시작점 (日上起時法)
hour_start_stems = [0, 2, 4, 6, 8]  # 갑기=갑, 을경=병, 병신=무, 정임=경, 무계=임
hour_start_stem = hour_start_stems[day_stem_idx % 5]
hour_stem_idx = (hour_start_stem + hour_branch_idx) % 10
```

#### 반환 구조
```python
{
    'year': {'gan': '갑', 'zhi': '자', 'gan_idx': 0, 'zhi_idx': 0, 'gan_element': 'wood', 'zhi_element': 'water'},
    'month': {...},
    'day': {...},
    'hour': {...}
}
```

---

### 2. 오행 분포 계산 `get_ohaeng_distribution(pillars)`

```python
dist = {'wood': 0, 'fire': 0, 'earth': 0, 'metal': 0, 'water': 0}
for key in ['year', 'month', 'day', 'hour']:
    dist[STEM_OHAENG[pillars[key]['gan_idx']]] += 1  # 천간
    dist[BRANCH_OHAENG[pillars[key]['zhi_idx']]] += 1  # 지지
# 총 8개 (천간4 + 지지4)
```

---

### 3. 십성(십신) 판정 `_determine_god(me_idx, target_idx, me_pol, target_pol)`

**오행 관계 계산**:
```python
diff = (target_idx - me_idx) % 5
# 0: 비견/겁재 (같은 오행)
# 1: 식신/상관 (내가 생함)
# 2: 편재/정재 (내가 극함)
# 3: 편관/정관 (나를 극함)
# 4: 편인/정인 (나를 생함)
```

**음양 판정**:
```python
is_same_polarity = (me_pol == target_pol)
# 같은 음양 → 비견, 식신, 편재, 편관, 편인
# 다른 음양 → 겁재, 상관, 정재, 정관, 정인
```

**지지 음양 보정** (특수 처리):
```python
zhi_polarities = [1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0]
# 자(음), 축(음), 인(양), 묘(음), 진(양), 사(양), 오(음), 미(음), 신(양), 유(음), 술(양), 해(양)
```

---

### 4. 대운 계산

#### 대운 방향 및 시작 나이 `get_daewoon(year_gan_idx, gender, day)`
```python
is_yang_year = (year_gan_idx % 2 == 0)
is_male = (gender == 'male')
is_forward = (is_yang_year and is_male) or (not is_yang_year and not is_male)
# 양남음녀 = 순행, 음남양녀 = 역행

daewoon_num = (day % 10) if (day % 10) != 0 else 10  # 대운 시작 나이
```

#### 대운 리스트 생성 `calculate_daewoon_list(...)`
```python
for i in range(8):  # 8주기 = 80년
    current_gan = (month_gan_idx + step * (i+1)) % 10
    current_zhi = (month_zhi_idx + step * (i+1)) % 12
    start_age = daewoon_num + (i * 10)
    advice = _get_daewoon_advice(day_master_gan_idx, current_gan)
```

#### 대운 조언 텍스트 `_get_daewoon_advice(day_master_gan_idx, daewoon_gan_idx)`

십성별 상세 조언 (각 100자 이상):
- **비견**: 동료/경쟁자, 협업 시너지
- **겁재**: 경쟁 심리, 재물 다툼
- **식신**: 재능 발휘, 창의력
- **상관**: 변화 추구, 언변
- **편재**: 사업 수완, 투자
- **정재**: 안정적 수입, 저축
- **편관**: 책임감, 리더십
- **정관**: 명예, 승진
- **편인**: 철학, 특수 기술
- **정인**: 학문, 문서운

---

### 5. 근묘화실 (생애주기) `get_geun_myo_hwa_sil(pillars)`

```python
{
    'year': {'period': '초년기 (0~19세)', 'desc': '...', 'pillar': pillars['year']},
    'month': {'period': '청년기 (20~39세)', 'desc': '...', 'pillar': pillars['month']},
    'day': {'period': '중년기 (40~59세)', 'desc': '...', 'pillar': pillars['day']},
    'hour': {'period': '말년기 (60세~)', 'desc': '...', 'pillar': pillars['hour']}
}
```

---

### 6. 오늘의 운세 `get_today_fortune(day_master_element, gender)`

```python
# 오늘의 일간과 본인 일간의 오행 관계 계산
diff = (today_idx - me_idx) % 5

fortunes = {
    0: {"title": "🤝 어깨를 나란히 하는 날", "desc": "..."},
    1: {"title": "🎨 재능이 꽃피는 날", "desc": "..."},
    2: {"title": "💰 결실을 맺는 날", "desc": "..."},
    3: {"title": "👑 명예가 드높은 날", "desc": "..."},
    4: {"title": "📚 귀인의 도움이 있는 날", "desc": "..."}
}
```

---

### 7. 일간별 핵심 성향 `_get_core_trait(master, element)`

10천간 각각에 대해 상세한 성격 분석 (각 150자 이상):

| 일간 | 상징 | 키워드 |
|------|------|--------|
| 갑 | 🌲 곧게 뻗은 소나무 | 리더십, 추진력, 자존심 |
| 을 | 🌿 강인한 생명력의 꽃 | 적응력, 유연함, 실속 |
| 병 | ☀️ 세상을 비추는 태양 | 열정, 솔직, 화려함 |
| 정 | 🕯️ 은근하게 타오르는 촛불 | 따뜻함, 섬세함, 헌신 |
| 무 | ⛰️ 묵직한 태산 | 믿음직함, 포용력, 신중 |
| 기 | 🌱 비옥한 텃밭 | 실속, 현실감각, 수용력 |
| 경 | 🪨 단단한 원석 | 의리, 결단력, 신념 |
| 신 | 💎 반짝이는 보석 | 섬세함, 미적감각, 자존심 |
| 임 | 🌊 드넓은 바다 | 지혜, 유연함, 창의력 |
| 계 | 🌧️ 촉촉한 단비 | 섬세함, 친화력, 지혜 |

---

## 📊 interpret() 메인 함수 반환 구조

```python
{
    'core': '핵심 성향 텍스트',
    'advice': '오행 기반 조언',
    'wealth': '재물운',
    'love': '애정운',
    'career': '직업 적성',
    'today_luck': {'date': '...', 'pillar': '...', 'title': '...', 'desc': '...'},
    'gmhs': {'year': {...}, 'month': {...}, 'day': {...}, 'hour': {...}},
    'ohaeng_analysis': {'percentages': {...}, 'details': [...], 'balance_text': '...'},
    'daewoon': [{'age': 5, 'gan': '갑', 'zhi': '자', 'text': '...'}, ...],  # 8개
    'ten_gods': {'year': {'gan': '비견', 'zhi': '정재'}, ...}
}
```
