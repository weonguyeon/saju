# 데이터 구조 명세서

## 📌 개요

이 문서는 프로그램 내에서 전달되는 모든 데이터 구조를 정의합니다.

---

## 📥 입력 데이터

### 폼 데이터 (POST /loading, POST /result)

| 키 | 타입 | 예시 | 설명 |
|----|------|------|------|
| `name` | string | "홍길동" | 사용자 이름 |
| `gender` | string | "male" | "male" 또는 "female" |
| `birth_date` | string | "1990-05-15" | 양력 생년월일 |
| `birth_time` | string | "14:30" | 태어난 시간 |

---

## 🏛️ 사주 원국 (pillars)

`saju.get_gan_zhi()` 반환 구조:

```python
{
    'year': {
        'gan': '경',           # 천간 한자
        'zhi': '오',           # 지지 한자
        'gan_idx': 6,          # 천간 인덱스 (0-9)
        'zhi_idx': 6,          # 지지 인덱스 (0-11)
        'gan_element': 'metal', # 천간 오행
        'zhi_element': 'fire'   # 지지 오행
    },
    'month': { ... },
    'day': { ... },
    'hour': { ... }
}
```

### 인덱스 참조표

**천간 (gan_idx)**:
| 인덱스 | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 |
|--------|---|---|---|---|---|---|---|---|---|---|
| 한자 | 갑 | 을 | 병 | 정 | 무 | 기 | 경 | 신 | 임 | 계 |
| 오행 | 목 | 목 | 화 | 화 | 토 | 토 | 금 | 금 | 수 | 수 |

**지지 (zhi_idx)**:
| 인덱스 | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 |
|--------|---|---|---|---|---|---|---|---|---|---|----|----|
| 한자 | 자 | 축 | 인 | 묘 | 진 | 사 | 오 | 미 | 신 | 유 | 술 | 해 |
| 오행 | 수 | 토 | 목 | 목 | 토 | 화 | 화 | 토 | 금 | 금 | 토 | 수 |

---

## 🔥 오행 분포 (ohaeng)

`saju.get_ohaeng_distribution()` 반환 구조:

```python
{
    'wood': 2,
    'fire': 1,
    'earth': 3,
    'metal': 1,
    'water': 1
}
# 총합: 8 (천간 4개 + 지지 4개)
```

---

## 📊 해석 데이터 (interp)

`saju.interpret()` + AI 병합 후 최종 구조:

```python
{
    # 기본 사주 로직 결과
    'core': '🌲 **곧게 뻗은 소나무 (갑목)**\n리더십이 강하고...',
    'advice': '💡 **강점 활용**: 목 기운이 강하시군요...',
    'wealth': '💰 **꾸준한 저축형**\n티끌 모아 태산...',
    'love': '💘 **순정파 사랑꾼**\n한번 마음을 주면...',
    'career': '표현력이 좋고 화려한 분야...',
    
    # AI 심층 분석 (AI 호출 성공 시)
    'total_summary': '당신은 타고난 리더십과...',
    'personality_deep': '내면의 당신은...',
    'social_analysis': '대인관계에서...',
    'health_analysis': '오행 밸런스를 보면...',
    'daewoon_trend': '현재 대운은...',
    'love_romance': '연애 패턴을 보면...',
    'wealth_strategy': '재물운을 분석하면...',
    
    # 오늘의 운세
    'today_luck': {
        'date': '2026년 01월 09일',
        'pillar': '갑자일',
        'title': '🤝 어깨를 나란히 하는 날',
        'desc': '주변 사람들과의 협력이 중요합니다...'
    },
    
    # 근묘화실 (생애주기)
    'gmhs': {
        'year': {
            'period': '초년기 (0~19세)',
            'desc': '초년기(근)는 인생의 뿌리입니다...',
            'pillar': {
                'gan': '경', 'zhi': '오',
                'gan_idx': 6, 'zhi_idx': 6,
                'gan_element': 'metal', 'zhi_element': 'fire'
            }
        },
        'month': {
            'period': '청년기 (20~39세)',
            'desc': '...',
            'pillar': {...}
        },
        'day': {
            'period': '중년기 (40~59세)',
            'desc': '...',
            'pillar': {...}
        },
        'hour': {
            'period': '말년기 (60세~)',
            'desc': '...',
            'pillar': {...}
        }
    },
    
    # 오행 분석
    'ohaeng_analysis': {
        'percentages': {
            'wood': 25.0,
            'fire': 12.5,
            'earth': 37.5,
            'metal': 12.5,
            'water': 12.5
        },
        'details': [
            {'element': 'earth', 'status': 'excess', 'msg': 'earth 기운이 강합니다...'},
            {'element': 'fire', 'status': 'missing', 'msg': 'fire 기운이 부족합니다...'}
        ],
        'balance_text': '비교적 균형 잡힌 구성이나, 일부 부족한 기운이 보이네요.'
    },
    
    # 대운 (8개)
    'daewoon': [
        {
            'age': 5,
            'gan': '을',
            'zhi': '축',
            'gan_element': 'wood',
            'zhi_element': 'earth',
            'text': '[비견] 나와 뜻을 같이하는 동료나 경쟁자가 나타나는 시기입니다...'
        },
        {
            'age': 15,
            'gan': '병',
            'zhi': '인',
            'gan_element': 'fire',
            'zhi_element': 'wood',
            'text': '[식신] 나의 재능과 기술을 마음껏 발휘하는 시기입니다...'
        },
        # ... 총 8개 (80세까지)
    ],
    
    # 십성 (십신)
    'ten_gods': {
        'year': {'gan': '편인', 'zhi': '정재'},
        'month': {'gan': '비견', 'zhi': '식신'},
        'day': {'gan': '나', 'zhi': '편관'},  # 일간은 항상 '나'
        'hour': {'gan': '상관', 'zhi': '정인'}
    }
}
```

---

## 🤖 AI 응답 구조

`ai.get_deep_analysis()` 반환 JSON:

```json
{
    "total_summary": "당신은... (8-12문장)",
    "gmhs": {
        "year": "초년기의 당신은... (5문장 이상)",
        "month": "청년기에는... (5문장 이상)",
        "day": "중년기는... (5문장 이상)",
        "hour": "말년기에는... (5문장 이상)"
    },
    "daewoon_trend": "현재 대운은... (8-12문장)",
    "health_analysis": "오행 밸런스를 보면... (8-12문장)",
    "social_analysis": "대인관계에서... (8-12문장)",
    "personality_deep": "내면의 당신은... (8-12문장)",
    "love_romance": "연애 패턴을 보면... (8-12문장)",
    "wealth_strategy": "재물운을 분석하면... (8-12문장)",
    "today_luck": "오늘은... (3-5문장)"
}
```

---

## 🔗 데이터 흐름 다이어그램

```
[사용자 입력]
     ↓
[app.py: 폼 파싱]
     ↓
[saju_logic.py: 사주 계산]
     ├─→ pillars (원국)
     ├─→ ohaeng (오행 분포)
     └─→ interpretations (기본 해석)
           ↓
[ai_analysis.py: GPT-4o 호출]
           ↓
[app.py: AI 결과 병합]
           ↓
[result.html: 렌더링]
     ├─→ {{ pillars }} → 사주표
     ├─→ {{ ohaeng }} → 차트 데이터
     └─→ {{ interp }} → 모든 해석 텍스트
```

---

## 📋 십성(십신) 매핑표

| diff | 같은 음양 | 다른 음양 |
|------|-----------|-----------|
| 0 (같은 오행) | 비견 | 겁재 |
| 1 (내가 생함) | 식신 | 상관 |
| 2 (내가 극함) | 편재 | 정재 |
| 3 (나를 극함) | 편관 | 정관 |
| 4 (나를 생함) | 편인 | 정인 |

**diff 계산**: `(target_element_idx - my_element_idx) % 5`

오행 인덱스: wood=0, fire=1, earth=2, metal=3, water=4
